from ConnectionUI import *
from ConnectionPixhawk import *
from ManualControl import *
#from Pixycam import *



master = ConnectToPixhawk()

arm_disarm = False



def Control(arm_disarm, roll, pitch, yaw, throttle, flight_mode):
	global master
	master = Arm_Disarm(master, arm_disarm)
	Move(master, roll, pitch, yaw, throttle, 0)
	ChangeFlightMode(master, flight_mode)
	

def Run():
	global arm_disarm, master
	commands = Receive()
	if(commands != None):
		#print(str(commands))
		msg = master.recv_match()
    		if not msg:
        		pass
    		if msg.get_type() == 'HEARTBEAT':
        		print("\n\n*****Got message: %s*****" % msg.get_type())
        		print("Message: %s" % msg)
        		print("\nAs dictionary: %s" % msg.to_dict())
        		# Armed = MAV_STATE_STANDBY (4), Disarmed = MAV_STATE_ACTIVE (3)

		send = {
			"arm_disarm":master.motors_armed(), 
		        "flight_mode":master.flightmode, 
     	 	        "pressure":0, 
		        "clamp": False,
			"light": False,
			"throttle":commands['throttle'],
			"roll":commands['roll'],
			"pitch":commands['pitch'],
			"yaw":commands['yaw']
		       }
		send = json.dumps(send)
		send = str(send)
		#print(send)
		#print(master.motors_armed())
		#send = GetPixyTarget()
		

		Send(bytearray(send))
			
		#PixyLamp(command['pixyLight'])

		

















if __name__ == "__main__":
	try:
		print("Running...")
		while True:
			Run()
	except KeyboardInterrupt:
		CloseConnection()
	except Exception as e:
		print(e)

